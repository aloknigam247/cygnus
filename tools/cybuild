#!/bin/bash

source $CYGNUS_HOME/tools/funcs.bash    # source common functions

declare BUILD_MODE=debug

OPTION['--clean']="value:bool,eval:BUILD_MODE=clean,help:clean generated files"
OPTION['--coverage']="value:bool,eval:BUILD_MODE=coverage,help:create coverage build"
OPTION['--debug']="value:bool,eval:BUILD_MODE=debug,help:create debug build"
OPTION['--force']="value:bool,help:forcefully remake"
OPTION['--memory']="value:bool,eval:BUILD_MODE=memory,help:use lint tool along with compilation"
OPTION['--perf']="value:bool,eval:BUILD_MODE=perf;BUILD_MODE=perf,help:create performance build"
OPTION['--release']="value:bool,eval:BUILD_MODE=release,help:create release build"
OPTION['--sanitize']="value:bool,eval:BUILD_MODE=sanitize,help:create sanitized build"
OPTION['--strict']="value:bool,eval:STRICT=yes,help:use strict options for compilation"

TEE() {
    echo "" > $1
    while IFS= read line; do
        echo "$line"
        echo "$line" | sed 's|\x1b\[[;0-9]*m\x1b\[K||g' >> $1
    done
}

MAKE() {
    {
    if [[ ${VALUES['--force']} ]]; then
        make clean
    fi

    if [[ ${VALUES['--strict']} ]]; then
        make -q && make clean
        make MODE=$1 STRICT=yes 2> >(TEE $report_dir/${BUILD_MODE}-errors)
    else
        make MODE=$1 2> >(TEE $report_dir/${BUILD_MODE}-errors)
    fi
    } | TEE logs/cybuild-${BUILD_MODE}.log
}

main() {
    if [[ ! $0 =~ $CYGNUS_HOME ]]; then
        LOG E "$(basename $0) is not inside $CYGNUS_HOME"
        return 1
    fi

    parseCmdLine $@
    local errors=0
    local report_dir="reports/compiler"
    mkdir -p $report_dir
    case $BUILD_MODE in
        clean)
            make clean
            ;;
        coverage)
            MAKE coverage
            ;;
        debug)
            MAKE debug
            ;;
        memory)
            MAKE memory
            ;;
        perf)
            MAKE perf
            ;;
        release)
            MAKE release
            ;;
        sanitize)
            MAKE sanitize
            ;;
        *)
            MAKE debug
            ;;
    esac

    test -f $report_dir/${BUILD_MODE}-errors \
        && errors=$(egrep -c "error:|warning:" $report_dir/${BUILD_MODE}-errors)
    echo -e "\e[1;31mErrors|Warnings: $errors\e[m"
    if [[ $errors -gt 0 ]]; then
        return 1
    fi
}

mkdir -p logs
main $@
exit $?
