version: 2.0

jobs:
  checkout:
    docker:
      - image: aloknigam247/cygnus
    working_directory: ~/cygnus
    steps:
      - checkout
      - run:
          name: Initial setup
          command: |
              cd ~/cygnus
              mkdir logs
              mkdir reports
      - persist_to_workspace:
          root: ~/
          paths:
            - cygnus

  comp-warnings:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Compiler Warnings on strict mode
          command: |
              cd ~/cygnus
              source sourceme
              cybuild --strict --release 2>&1 | tee logs/warnings.log
      - persist_to_workspace:
          root: ~/
          paths:
            - cygnus

  func-tests:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Run Unit Test
          command: |
            cd ~/cygnus
            source sourceme
            cyregress -f -d tests 2>&1 | tee logs/func_test.log
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports
            - logs
  
  unit-tests:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Run Unit Test
          command: |
            cd ~/cygnus
            source sourceme
            cyregress -u -d tests 2>&1 | tee unit_test.log
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports
            - logs
  
  perf-checks:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  mem-checks:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Memory Checks
          command: |
              cd ~/cygnus
              source sourceme
              cyregress -a -d tests --mem-check 2>&1 | tee logs/mem-checks.log
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  unit-cov:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Coverage Run
          command: |
              cd ~/cygnus
              source sourceme
              cyregress -u -d tests --coverage
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  func-cov:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Coverage Run
          command: |
              cd ~/cygnus
              source sourceme
              cyregress -f -d tests --coverage
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  lint-checks:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Lint Run
          command: echo "Disabled"
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  docs-checks:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Generate Docs
          command: |
            cd ~/cygnus
            source sourceme
            gen-docs
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  code-style:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - persist_to_workspace:
          root: ~/cygnus
          paths:
            - reports

  report-gen:
    docker:
      - image: aloknigam247/cygnus
    steps:
      - attach_workspace:
          at: ~/
      - run:
          name: Report Generation
          command: |
              cd ~
              source cygnus/sourceme
              gen-report | tee report.log
      - store_artifacts:
          path: ~/logs
          destination: Logs
      - store_artifacts:
          path: ~/reports
          destination: Reports

workflows:
  version: 2
  Commit-Regression:
    jobs:
      - checkout
      - comp-warnings:
          requires:
            - checkout
      - func-tests:
          requires:
            - comp-warnings
      - func-cov:
          requires:
            - checkout
      - unit-tests:
          requires:
            - checkout
      - perf-checks:
          requires:
            - checkout
      - mem-checks:
          requires:
            - checkout
      - unit-cov:
          requires:
            - checkout
      - lint-checks:
          requires:
            - checkout
      - docs-checks:
          requires:
            - checkout
      - code-style:
          requires:
            - checkout
      - report-gen:
          requires:
            - func-tests
            - func-cov
            - unit-tests
            - unit-cov
            - perf-checks
            - mem-checks
            - lint-checks
            - docs-checks
            - code-style
